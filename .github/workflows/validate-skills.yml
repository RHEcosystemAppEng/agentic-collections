name: Validate Skills

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main

jobs:
  validate:
    name: Validate Skill Structure and Requirements
    runs-on: ubuntu-latest

    # Skip draft PRs
    if: github.event.pull_request.draft == false || github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better diff analysis

      - name: Detect changed skills
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/skills/**/SKILL.md

      - name: List changed skills
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed skill files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Run validation script (all skills)
        run: |
          echo "Running universal skill validation..."
          echo ""
          ./scripts/validate-skills.sh --verbose

      - name: Validation Summary
        if: success()
        run: |
          echo ""
          echo "‚úÖ All skills passed validation"
          echo ""
          echo "Validated against:"
          echo "  - Tier 1: agentskills.io specification (MANDATORY)"
          echo "  - Tier 2: Repository design principles (MANDATORY)"
          echo ""
          echo "See SKILL_CHECKLIST.md for complete requirements."

      - name: Validation Failed
        if: failure()
        run: |
          echo ""
          echo "‚ùå Skill validation failed"
          echo ""
          echo "Please review the errors above and ensure your skills meet all requirements in:"
          echo "  üìã SKILL_CHECKLIST.md"
          echo ""
          echo "Common issues:"
          echo "  - Missing or invalid 'model' field (must be: inherit, sonnet, or haiku)"
          echo "  - Missing or invalid 'color' field (must be: cyan, green, blue, yellow, or red)"
          echo "  - Invalid SKILL.md header format (must be: # /<skill-name> Skill)"
          echo "  - Missing required sections (Prerequisites, When to Use, Workflow, Dependencies)"
          echo "  - Missing 'NOT for' anti-patterns in description"
          echo ""
          echo "To validate locally:"
          echo "  ./scripts/validate-skills.sh path/to/skill/"
          exit 1
